# 성장 기업 예측 모델 전체 흐름 및 해석 가이드

## 📊 전체 프로세스 흐름

```
[1단계] 피처 생성 (field_per_feture.py)
    ↓
재무정보_final_imputed.csv (2016~2024년 데이터)
    ↓
롤링 패널 방식으로 피처 생성
    ↓
growth_features_rolling.csv (2,335개 샘플, 12개 피처)
    ↓
[2단계] 타겟 변수 생성 (모델링 코드 내부)
    ↓
각 연도별 매출액 성장률 계산 → 상위 30% 기준으로 이진 분류
    ↓
[3단계] 모델 학습 (LightGBM / XGBoost)
    ↓
Train: 2019~2022년 데이터 (1,074개)
Test: 2023년 데이터 → 2024년 예측 (368개)
    ↓
[4단계] 예측 결과
    ↓
test_predictions_2024.csv (2024년 상위 30% 기업 예측)
```

---

## 🔄 롤링 패널 데이터 구조

### 피처 생성 방식
각 연도별로 **t-1, t-2, t-3년 데이터**를 사용하여 피처를 생성합니다.

| 피처 시점 | 사용하는 데이터 | 타겟 시점 | 용도 |
|---------|---------------|---------|------|
| 2019년 말 | 2017~2019년 재무데이터 | 2020년 성장여부 | Train |
| 2020년 말 | 2018~2020년 재무데이터 | 2021년 성장여부 | Train |
| 2021년 말 | 2019~2021년 재무데이터 | 2022년 성장여부 | Train |
| 2022년 말 | 2020~2022년 재무데이터 | 2023년 성장여부 | Train |
| 2023년 말 | 2021~2023년 재무데이터 | **2024년 성장여부** | **Test** |

### 예시: 2023년 말 피처 → 2024년 예측
- **피처 계산에 사용**: 2021, 2022, 2023년 재무데이터 (2023년 말 시점)
- **타겟 계산에 사용**: 2023년과 2024년 매출액 비교
- **예측 결과**: 2024년 매출액 성장률이 상위 30%인지 여부

---

## 📈 사용되는 12개 피처 설명

### 1. revenue_t1 (현재 규모)
- **계산식**: feature_year 매출액
- **의미**: 기업의 현재 규모
- **예시**: 2023년 말 피처 → 2023년 매출액 사용

### 1. revenue_t1 (현재 규모)
- **계산식**: feature_year 매출액
- **의미**: 기업의 현재 규모
- **예시**: 2023년 말 피처 → 2023년 매출액 사용

### 2. cagr_2y (중기 성장 속도)
- **계산식**: (feature_year 매출액 / (feature_year-2)년 매출액)^(1/2) - 1
- **의미**: 2년간 연평균 성장률
- **예시**: 2023년 말 피처 → (2023년 / 2021년)^(1/2) - 1

### 3. growth_recent (최근 모멘텀)
- **계산식**: (feature_year 매출액 / (feature_year-1)년 매출액) - 1
- **의미**: 최근 1년간 성장률
- **예시**: 2023년 말 피처 → (2023년 / 2022년) - 1

### 4. growth_acceleration (성장 가속/감속)
- **계산식**: 최근성장률 - 초기성장률
  - 최근성장률 = (feature_year / (feature_year-1)) - 1
  - 초기성장률 = ((feature_year-1) / (feature_year-2)) - 1
- **의미**: 성장이 가속화되는지 감속되는지
- **예시**: 2023년 말 피처 → (2023/2022 - 1) - (2022/2021 - 1)

### 5. growth_volatility (안정성)
- **계산식**: std(연도별 매출액 성장률)
- **의미**: 성장률의 변동성 (낮을수록 안정적)
- **예시**: 2021~2023년 성장률들의 표준편차

### 6. profitable_years (수익 안정성)
- **계산식**: 최근 2년 중 영업이익 > 0인 연도 수
- **의미**: 수익성 안정성 (0, 1, 2)
- **예시**: 2022, 2023년 중 영업이익이 양수인 연도 수

### 7. capex_intensity (투자 강도)
- **계산식**: CAPEX / 매출액
- **의미**: 매출 대비 투자 규모
- **예시**: 2023년 CAPEX / 2023년 매출액

### 8. capex_trend (투자 추세)
- **계산식**: (feature_year CAPEX / (feature_year-1)년 CAPEX) - 1
- **의미**: 투자 증가/감소 추세
- **예시**: 2023년 말 피처 → (2023년 CAPEX / 2022년 CAPEX) - 1

### 9. capex_vs_industry (업종 대비 수준)
- **계산식**: 기업 CAPEX - 업종 평균 CAPEX
- **의미**: 같은 업종(소재/부품/장비) 대비 투자 수준
- **예시**: 기업 CAPEX - (같은 field, 같은 연도의 평균 CAPEX)

### 10. operating_margin (영업이익률)
- **계산식**: 영업이익 / 매출액
- **의미**: 영업 효율성
- **예시**: 2023년 영업이익 / 2023년 매출액

### 11. debt_ratio (부채비율)
- **계산식**: 부채총계 / 자본총계
- **의미**: 재무 안정성
- **예시**: 2023년 부채총계 / 2023년 자본총계

### 12. rnd_intensity (R&D 집중도)
- **계산식**: 연구개발비 / 매출액
- **의미**: 혁신 투자 수준
- **예시**: 2023년 연구개발비 / 2023년 매출액

---

## 🎯 타겟 변수 생성 방식

### 1단계: 매출액 성장률 계산
각 기업별로 다음 연도의 매출액 성장률을 계산합니다.

```
성장률 = (다음 연도 매출액 / 현재 연도 매출액) - 1
```

**예시:**
- 2023년 말 피처 → 2024년 타겟
- (2024년 매출액 / 2023년 매출액) - 1

### 2단계: 상위 30% 기준 설정
각 타겟 연도별로 모든 기업의 성장률을 계산한 후, **70th percentile (상위 30% 기준)**을 구합니다.

**예시:**
- 2024년 타겟의 경우, 모든 기업의 2024년 성장률을 계산
- 상위 30% 기준: 0.1996 (19.96% 이상이면 상위 30%)

### 3단계: 이진 분류 타겟 생성
- **1 (상위 30%)**: 성장률 ≥ 상위 30% 기준
- **0 (하위 70%)**: 성장률 < 상위 30% 기준

---

## 🤖 모델 학습 및 예측

### 데이터 분할
- **Train**: 2019~2022년 말 피처 (1,784개)
  - Train/Validation 분리: 80/20 (1,427개 / 357개)
- **Test**: 2023년 말 피처 → 2024년 예측 (446개)

### 모델 타입
- **LightGBM**: 이진 분류 (binary classification)
- **XGBoost**: 이진 분류 (binary:logistic)

### 하이퍼파라미터 튜닝
- **방법**: Optuna (Bayesian Optimization)
- **목표 지표**: ROC-AUC (최대화)
- **Trials**: 50회
- **최적 파라미터 저장**: `model/*/best_params.txt`

### 예측 출력
모델은 두 가지 값을 출력합니다:
1. **predicted_probability**: 상위 30%일 확률 (0~1)
2. **predicted_top30**: 이진 예측 (0.5 기준)
   - probability ≥ 0.5 → 1 (상위 30%)
   - probability < 0.5 → 0 (하위 70%)

---

## 📊 모델 결과 해석 방법

### 예측 결과 파일 구조
`test_predictions_2024.csv`에는 다음 정보가 포함됩니다:

| 컬럼 | 설명 | 예시 |
|------|------|------|
| `기업명` | 예측 대상 기업 | (주)나노젯코리아 |
| `연도` | 피처 기준 연도 | 2023 |
| `predicted_top30` | 모델 예측 (0 또는 1) | 0 = 하위 70%, 1 = 상위 30% |
| `predicted_probability` | 상위 30%일 확률 | 0.2677 = 26.77% |
| `actual_top30` | 실제 결과 (0 또는 1) | 0 = 실제 하위 70%, 1 = 실제 상위 30% |

### 해석 예시

#### 예시 1: 정확한 예측
```
기업: (주)나노젯코리아
predicted_probability: 0.2677 (26.77%)
predicted_top30: 0 (하위 70%로 예측)
actual_top30: 0 (실제 하위 70%)
→ 정확한 예측 ✓
```

#### 예시 2: 오류 예측
```
기업: (주)룩센테크놀러지
predicted_probability: 0.3360 (33.60%)
predicted_top30: 0 (하위 70%로 예측)
actual_top30: 1 (실제 상위 30%)
→ False Negative (상위 30%인데 하위로 예측)
```

#### 예시 3: 높은 확률로 상위 30% 예측
```
기업: 주식회사 쎄닉
predicted_probability: 0.7655 (76.55%)
predicted_top30: 1 (상위 30%로 예측)
actual_top30: 1 (실제 상위 30%)
→ 정확한 예측 ✓
```

### 확률 해석
- **0.5 이상**: 상위 30%일 가능성이 높음
- **0.7 이상**: 매우 높은 확률로 상위 30%
- **0.3 이하**: 하위 70%일 가능성이 높음

### 실제 활용 방법
1. **투자 후보 선정**: `predicted_probability`가 높은 기업 우선 검토
2. **리스크 관리**: 확률이 중간(0.3~0.7)인 기업은 추가 검토 필요
3. **성과 평가**: `predicted_top30`과 `actual_top30` 비교로 모델 성능 확인

---

## 📈 모델 성능 지표 해석 (하이퍼파라미터 튜닝 적용)

### LightGBM 모델 성능 (2023년 말 피처 → 2024년 예측)

#### Accuracy (정확도)
- **의미**: 전체 예측 중 정확한 비율
- **LightGBM**: 70.63% (446개 중 315개 정확)
- **해석**: 10개 중 약 7.1개를 정확히 예측

#### Precision (정밀도)
- **의미**: 상위 30%로 예측한 것 중 실제로 상위 30%인 비율
- **LightGBM**: 51.47%
- **해석**: 상위 30%로 예측한 68개 중 35개가 실제 상위 30%

#### Recall (재현율)
- **의미**: 실제 상위 30% 중 모델이 찾아낸 비율
- **LightGBM**: 26.32%
- **해석**: 실제 상위 30% 133개 중 35개를 찾아냄

#### F1-Score
- **의미**: Precision과 Recall의 조화평균
- **LightGBM**: 34.83%
- **해석**: Precision과 Recall의 균형

#### ROC-AUC
- **의미**: 모델의 분류 능력 (1.0에 가까울수록 좋음)
- **LightGBM**: 0.6637
- **해석**: 랜덤(0.5)보다 우수한 분류 능력

### XGBoost 모델 성능 (2023년 말 피처 → 2024년 예측)

#### Accuracy (정확도)
- **XGBoost**: 68.61% (446개 중 306개 정확)
- **해석**: 10개 중 약 6.9개를 정확히 예측

#### Precision (정밀도)
- **XGBoost**: 46.07%
- **해석**: 상위 30%로 예측한 89개 중 41개가 실제 상위 30%

#### Recall (재현율)
- **XGBoost**: 30.83%
- **해석**: 실제 상위 30% 133개 중 41개를 찾아냄

#### F1-Score
- **XGBoost**: 36.94%
- **해석**: Precision과 Recall의 균형

#### ROC-AUC
- **XGBoost**: 0.6333
- **해석**: 랜덤(0.5)보다 우수한 분류 능력

### 모델 비교 요약

| 지표 | LightGBM | XGBoost | 우수 모델 |
|------|----------|---------|----------|
| Accuracy | 70.63% | 68.61% | **LightGBM** |
| Precision | 51.47% | 46.07% | **LightGBM** |
| Recall | 26.32% | 30.83% | **XGBoost** |
| F1-Score | 34.83% | 36.94% | **XGBoost** |
| ROC-AUC | 0.6637 | 0.6333 | **LightGBM** |

**결론**: 
- **LightGBM**: Accuracy, Precision, ROC-AUC에서 우수 → 정확한 예측에 강점
- **XGBoost**: Recall과 F1-Score에서 우수 → 더 많은 상위 30% 기업을 찾아냄
- **권장**: 정확한 예측이 중요한 경우 LightGBM, 더 많은 기업을 찾아내는 것이 중요한 경우 XGBoost

---

## 🔍 Confusion Matrix 해석 (하이퍼파라미터 튜닝 적용)

### LightGBM Confusion Matrix

```
                예측
실제      하위 70%   상위 30%
하위 70%    280        33
상위 30%     98        35
```

- **True Negative (280)**: 하위 70%를 하위로 정확히 예측
- **False Positive (33)**: 하위 70%를 상위로 잘못 예측
- **False Negative (98)**: 상위 30%를 하위로 잘못 예측 (놓친 기업)
- **True Positive (35)**: 상위 30%를 상위로 정확히 예측

**분석**: Precision이 향상되어 False Positive가 감소 (43 → 33)

### XGBoost Confusion Matrix

```
                예측
실제      하위 70%   상위 30%
하위 70%    265        48
상위 30%     92        41
```

- **True Negative (265)**: 하위 70%를 하위로 정확히 예측
- **False Positive (48)**: 하위 70%를 상위로 잘못 예측
- **False Negative (92)**: 상위 30%를 하위로 잘못 예측 (놓친 기업)
- **True Positive (41)**: 상위 30%를 상위로 정확히 예측

**분석**: Recall이 크게 향상되어 True Positive가 증가 (11 → 41)

---

## 💡 모델 개선 포인트 (하이퍼파라미터 튜닝 적용)

### 하이퍼파라미터 튜닝 효과

#### LightGBM 개선 사항:
- **Accuracy**: 69.28% → 70.63% (+1.35%p)
- **Precision**: 47.56% → 51.47% (+3.91%p)
- **ROC-AUC**: 0.6449 → 0.6637 (+0.0188)
- **False Positive 감소**: 43개 → 33개

#### XGBoost 개선 사항:
- **Accuracy**: 63.04% → 68.61% (+5.57%p)
- **Precision**: 20.37% → 46.07% (+25.70%p) ⭐
- **Recall**: 10.58% → 30.83% (+20.25%p) ⭐
- **F1-Score**: 13.92% → 36.94% (+23.02%p) ⭐
- **ROC-AUC**: 0.5291 → 0.6333 (+0.1042) ⭐

### 현재 모델의 한계:

#### LightGBM 모델의 한계:
1. **Recall이 개선 필요**: 실제 상위 30% 중 26.32%만 찾아냄 (133개 중 35개)
2. **False Negative가 많음**: 상위 30% 기업 98개를 놓침
3. **ROC-AUC 개선 여지**: 0.6637로 양호하나 더 개선 가능

#### XGBoost 모델의 한계:
1. **Recall이 여전히 낮음**: 실제 상위 30% 중 30.83%만 찾아냄 (133개 중 41개)
2. **False Negative가 많음**: 상위 30% 기업 92개를 놓침
3. **ROC-AUC 개선 여지**: 0.6333로 향상되었으나 더 개선 가능

개선 방향:
- 피처 추가/개선
- 하이퍼파라미터 튜닝
- 임계값(threshold) 조정 (0.5 → 다른 값)
- 앙상블 모델 사용

---

## 📝 요약

1. **피처**: 2017~2023년 재무데이터로 12개 피처 생성 (롤링 패널 방식)
2. **타겟**: 다음 연도 매출액 성장률이 상위 30%인지 여부 (0 또는 1)
3. **모델**: LightGBM과 XGBoost 이진 분류 모델 (하이퍼파라미터 튜닝 적용)
4. **하이퍼파라미터 튜닝**: Optuna를 사용한 50 trials 최적화
5. **결과**: 2024년 상위 30% 기업 예측 및 실제와 비교
   - **LightGBM**: Accuracy 70.63%, Precision 51.47%, Recall 26.32%, ROC-AUC 0.6637
   - **XGBoost**: Accuracy 68.61%, Precision 46.07%, Recall 30.83%, ROC-AUC 0.6333
6. **해석**: `predicted_probability`가 높을수록 상위 30% 가능성 높음
7. **권장 모델**: 
   - 정확한 예측이 중요한 경우: **LightGBM** (Accuracy, Precision 우수)
   - 더 많은 기업을 찾아내는 것이 중요한 경우: **XGBoost** (Recall 우수)